import{a as B}from"./axios-http-ngrFHoWO.js";import{_ as D}from"./index-BQ4r-PLg.js";import{r as z,c as T,ap as V,a as F,o as H,s as p,y as E,t as P,K as W,k as J,x as K,J as G}from"./vue-chunks-sUkSM7pP.js";import"./vue-ecosystem-CD19DsTg.js";import"./vendor-other-BTrOqZDZ.js";import"./element-core-8PBMEAXG.js";const Q=3030,k=B.create({baseURL:`https:locahost:${Q}`,timeout:2e3});function X(d,o){const h=new AbortController,L=h.signal,u=k({url:"/upload",method:"post",data:d,signal:L});return typeof o=="function"&&o(()=>h.abort()),u}function Y(d){return k({url:"/merge",method:"post",data:d})}function Z(d){return k({url:"/verify",method:"post",data:d})}const j={class:"container2"},O={class:"page_top"},I={class:"content",ref:"contentRef"},A={class:"bottom_box"},ee={class:"input_btn"},w=1*1024*1024,le={__name:"UploadModule",setup(d){const o=z([]),h=z(6),L=T(()=>`${o.value.filter(l=>l.state!==4).length}/${o.value.length}`),u=(e,l=!0)=>{if([4,6].includes(e.state)||(l?e.state=3:e.state=5),e.errNumber=0,e.whileRequests.length>0)for(const i of e.whileRequests)i.cancel&&i.cancel()},R=e=>{e.state=2,e.allChunkList.push(...e.whileRequests),e.whileRequests=[],C(e)},x=e=>new Promise(l=>{const i=new Worker(new URL("/yike/assets/worker-BbhpWhlD.js",import.meta.url));i.postMessage({file:e,chunkSize:w}),console.log("log { file, chunkSize: chunkSize }",{file:e,chunkSize:w}),i.onmessage=a=>{const{fileHash:t,fileChunkList:n,percentage:s}=a.data;t&&l({percentage:s,fileHash:t,fileChunkList:n})}}),$=async e=>{u(e),o.value=o.value.filter(l=>l.fileHash!==e.fileHash)},q=()=>{for(const e of o.value)u(e);o.value=[]},S=async e=>{const{fileName:l,fileHash:i}=e,a=await Y({chunkSize:w,fileName:l,fileHash:i}).catch(()=>{});a&&a.code===0?(y(e),console.log("文件合并成功！")):(u(e,!0),console.log("文件合并失败！")),e.finishNumber=0},U=(e,l)=>{l.percentage=Number((l.finishNumber/e.chunkNumber*100).toFixed(2))},y=e=>{e.percentage=100,e.state=4},C=e=>{if(e.allChunkList.length===0||e.whileRequests.length>0)return!1;const l=o.value.filter(t=>t.state===1||t.state===2);h.value=Math.ceil(6/l.length);let i=e.allChunkList.slice(-h.value);e.whileRequests.push(...i),e.allChunkList.length>h.value?e.allChunkList.splice(-h.value):e.allChunkList=[];const a=async t=>{const n=new FormData,{fileHash:s,fileSize:f,fileName:N,index:r,chunkFile:v,chunkHash:m,chunkSize:b,chunkNumber:_}=t;n.append("fileHash",s),n.append("fileSize",String(f)),n.append("fileName",N),n.append("index",String(r)),n.append("chunkFile",v),n.append("chunkHash",m),n.append("chunkSize",String(b)),n.append("chunkNumber",String(_));const c=await X(n,g=>{t.cancel=g}).catch(()=>{});if(e.state===3||e.state===5)return!1;!c||c.code===-1?(e.errNumber++,e.errNumber>3?(console.log("切片上传失败超过三次了"),u(e,!1)):(console.log("切片上传失败还没超过3次"),a(t))):c.code===0&&(e.errNumber>0&&e.errNumber--,e.finishNumber++,t.finish=!0,U(t,e),e.whileRequests=e.whileRequests.filter(g=>g.chunkFile!==t.chunkFile),e.finishNumber===_?S(e):C(e))};for(const t of i)a(t)},M=async e=>{const l=e.target;if(!l||!l.files||l.files.length===0)return!1;const i=l.files;console.log(`事件target：${l}，target.files：${i}`,l,i),Array.from(i).forEach(async(a,t)=>{const n=a;let s=G({id:new Date+t,state:0,fileHash:"",fileName:n.name,fileSize:n.size,allChunkList:[],whileRequests:[],finishNumber:0,errNumber:0,percentage:0,cancel:null});o.value.push(s),s.state=1,n.size===0&&(s.state=6,u(s,!1)),console.log("文件开始解析");const{fileHash:f,fileChunkList:N}=await x(n);console.log(f,"文件hash计算完成");let r="";const v=n.name.lastIndexOf(".");v===-1&&(r=n.name),r=n.name.slice(0,v),s.fileHash=`${f}${r}`,s.state=2;try{const m=await Z({fileHash:`${f}${r}`,fileName:n.name});if(m.code===0){const{shouldUpload:b,uploadedList:_}=m.data;if(!b)return y(s),console.log("文件已存在，实现秒传"),!1;if(s.allChunkList=N.map((c,g)=>({fileHash:`${f}${r}`,fileSize:n.size,fileName:n.name,index:g,chunkFile:c.chunkFile,chunkHash:`${f}-${g}`,chunkSize:w,chunkNumber:N.length,finish:!1})),_.length>0)if(s.allChunkList=s.allChunkList.filter(c=>!_.includes(c.chunkHash)),s.allChunkList.length)s.allChunkList=s.allChunkList.map(c=>({...c,chunkNumber:s.allChunkList.length}));else return await S(s),!1;C(s)}}catch{}})};return(e,l)=>{const i=V("ListItem");return H(),F("div",j,[p("div",O,[p("p",null,"正在上传 ("+E(L.value)+")",1),p("div",{class:"page_top_right",style:P({"justify-content":o.value.length>1?"space-between":"flex-end"})},[o.value.length>1?(H(),F("p",{key:0,class:"clear_btn",onClick:q}," 全部取消 ")):W("",!0)],4)]),p("div",I,[J(i,{uploadFileList:o.value,onPauseUpload:u,onResumeUpload:R,onCancelSingle:$},null,8,["uploadFileList"])],512),p("div",A,[p("div",ee,[l[0]||(l[0]=K(" 选择上传视频 ",-1)),p("input",{type:"file",multiple:"",class:"is_input",onChange:M},null,32)])])])}}},ce=D(le,[["__scopeId","data-v-e540a58e"]]);export{ce as default};
