(function(){"use strict";self.importScripts("spark-md5.min.js"),console.log("worker is working!!!");const l=5*1024*1024;function i(e,s){return new Promise((o,a)=>{let r=[],n=0;for(console.group();n<e.size;)r.push({chunkFile:e.slice(n,n+s)}),n+=s,console.log(`å½“å‰åˆ‡å‰²ä½ç½®ç›¸å¯¹æ•´ä¸ªæ–‡ä»¶çš„å¤§å°${n/1024/1024}MBï¼Œæ€»è®¡${e.size/1024/1024}MB`);console.groupEnd(),o(r)})}const f=async(e,s)=>{try{const o=new SparkMD5.ArrayBuffer,a=new FileReader;a.readAsArrayBuffer(e),a.onload=n=>{o.append(n.target.result)},a.onerror=n=>{reject(n)};const r=o.end();console.log(`å…¨é‡æ–‡ä»¶MD5${r}`),self.postMessage({percentage:100,fileHash:r,fileChunkList:s}),self.close()}catch(o){self.postMessage({name:"error",data:o}),self.close()}};async function u(e){const s=new SparkMD5.ArrayBuffer;let o=0;async function a(r){return r>=e.length?s.end():new Promise((n,g)=>{const t=new FileReader;t.readAsArrayBuffer(e[r].chunkFile),t.onload=c=>{s.append(c.target.result),o+=100/e.length,self.postMessage({percentage:o}),n(a(r+1))},t.onerror=c=>{g(c)}})}try{const r=await a(0);console.log("æ–‡ä»¶åˆ‡ç‰‡ç»“æœ",r),self.postMessage({percentage:100,fileHash:r,fileChunkList:e}),self.close()}catch(r){self.postMessage({name:"error",data:r}),self.close()}}onmessage=async e=>{try{const{file:s,chunkSize:o}=e.data,a=await i(s,o);s.size<l?(console.log(`æ–‡ä»¶çš„å¤§å°å°äº${l/1024/1024}MBï¼Œé‡‡ç”¨å…¨é‡è®¡ç®—ï¼Œå¯èƒ½ä¼šå´©æºƒğŸ˜«,å¦‚æœè¿™éƒ½å—ä¸äº†ï¼Œè¿˜çœŸæ˜¯ä¸€ä¸ªæ‚é±¼æµè§ˆå™¨å‘¢â¤ï¸â¤ï¸â¤ï¸`),await f(s,a)):await u(a)}catch(s){console.error("workerç›‘å¬å‘ç”Ÿé”™è¯¯:",s)}},onerror=e=>{console.log("Workerè§¦å‘ä¸»çº¿ç¨‹çš„erroräº‹ä»¶ï¼š",e),self.close()}})();
